<!-- SalesforceFlow BPEL Process [Generated by the BPEL Designer]  -->
<process name="SalesforceFlow" targetNamespace="http://samples.otn.com" 
    suppressJoinFailure="yes" xmlns:tns="http://samples.otn.com" 
    xmlns="http://schemas.xmlsoap.org/ws/2003/03/business-process/" 
    xmlns:bpelx="http://schemas.oracle.com/bpel/extension" 
    xmlns:ora="http://schemas.oracle.com/xpath/extension" 
    xmlns:wsa="http://schemas.xmlsoap.org/ws/2003/03/addressing" 
    xmlns:bpws="http://schemas.xmlsoap.org/ws/2003/03/business-process/"
    xmlns:salesforce="urn:enterprise.soap.sforce.com"
    xmlns:salesObject="urn:sobject.enterprise.soap.sforce.com">
	<!-- ================================================================= -->
	<!-- PARTNERLINKS                                                      -->
	<!-- List of services participating in this BPEL process               -->
	<!-- ================================================================= -->
	<partnerLinks>
		<!--
        The 'client' role represents the requester of this service. It is
        used for callback. The location and correlation information associated
        with the client role are automatically set using WS-Addressing.
        -->
		<partnerLink name="client" partnerLinkType="tns:SalesforceFlow" myRole="SalesforceFlowProvider" partnerRole="SalesforceFlowRequester"/>
		<partnerLink name="salesforce" partnerLinkType="salesforce:SoapLink" partnerRole="SoapProvider"/>
	</partnerLinks>
	<!-- ================================================================= -->
	<!-- VARIABLES                                                         -->
	<!-- List of messages and XML documents used within this BPEL process  -->
	<!-- ================================================================= -->
	<variables>
		<!-- Reference to the message passed as input during initiation -->
		<variable name="input" messageType="tns:SalesforceFlowRequestMessage"/>
		<!-- Reference to the message that will be sent back to the
             requester during callback
             -->
		<variable name="output" messageType="tns:SalesforceFlowResponseMessage"/>
	</variables>
	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC                                               -->
	<!-- Set of activities coordinating the flow of messages across the    -->
	<!-- services integrated within this business process                  -->
	<!-- ================================================================= -->
	<sequence name="main">
		<!-- Receive input from requestor.
             Note: This maps to operation defined in SalesforceFlow.wsdl
             -->
		<receive name="receiveInput" partnerLink="client" portType="tns:SalesforceFlow" operation="initiate" variable="input" createInstance="yes"/>

		<scope name="customerPreference">
			<variables>
				<variable messageType="salesforce:loginRequest" name="loginRequest"/>
				<variable messageType="salesforce:loginResponse" name="loginResponse"/>
				<variable messageType="salesforce:Header" name="headerRequest"/>
				<variable messageType="salesforce:queryRequest" name="queryRequest"/>
				<variable messageType="salesforce:queryResponse" name="queryResponse"/>
				<variable name="partnerReference" element="wsa:EndpointReference"/>
			</variables>
			<sequence>
				<assign name="setSalesforceAuthorization">
					<copy>
						<from variable="input" part="payload" query="/tns:SalesforceFlowRequest/tns:username">
						</from>
						<to variable="loginRequest" part="parameters" query="/salesforce:login/salesforce:username"/>
					</copy>
					<copy>
						<from variable="input" part="payload" query="/tns:SalesforceFlowRequest/tns:password">
						</from>
						<to variable="loginRequest" part="parameters" query="/salesforce:login/salesforce:password"/>
					</copy>
				</assign>
				<invoke partnerLink="salesforce" portType="salesforce:Soap" operation="login" inputVariable="loginRequest" outputVariable="loginResponse"/>
				<assign name="readSessionConfig">
					<copy>
						<from variable="loginResponse" part="parameters" query="/salesforce:loginResponse/salesforce:result/salesforce:sessionId">
						</from>
						<to variable="headerRequest" part="SessionHeader" query="/salesforce:SessionHeader/salesforce:sessionId"/>
					</copy>
					<copy>
						<from>
							<EndpointReference xmlns="http://schemas.xmlsoap.org/ws/2003/03/addressing">
								<Address/>
							</EndpointReference>
						</from>
						<to variable="partnerReference"/>
					</copy>
					<copy>
						<from expression="string(bpws:getVariableData('loginResponse', 'parameters', '/salesforce:loginResponse/salesforce:result/salesforce:serverUrl'))">
						</from>
						<to variable="partnerReference" query="/wsa:EndpointReference/wsa:Address"/>
					</copy>
					<copy>
						<from variable="partnerReference"/>
						<to partnerLink="salesforce"/>
					</copy>
					<copy>
						<from expression="concat( 'select AccountNumber,SLA__c from account where AccountNumber=',ora:addQuotes( string(bpws:getVariableData('input','payload','/tns:SalesforceFlowRequest/tns:accountNumber'))) )">
						</from>
						<to variable="queryRequest" part="parameters" query="/salesforce:query/salesforce:queryString"/>
					</copy>
				</assign>
				<invoke partnerLink="salesforce" portType="salesforce:Soap" operation="query" inputVariable="queryRequest" bpelx:inputHeaderVariable="headerRequest" outputVariable="queryResponse"/>
				<switch name="calculateDiscount">
					<case condition="bpws:getVariableData('queryResponse', 'parameters','/salesforce:queryResponse/salesforce:result/salesforce:records/salesObject:SLA__c') = 'Platinum'">
						<assign name="setDiscount">
							<copy>
								<from expression="ceiling(bpws:getVariableData( 'input','payload','/tns:SalesforceFlowRequest/tns:price' ) - bpws:getVariableData( 'input','payload','/tns:SalesforceFlowRequest/tns:price' ) * 0.3)">
								</from>
								<to variable="output" part="payload" query="/tns:SalesforceFlowResponse/tns:price"/>
							</copy>
						</assign>
					</case>
					<case condition="bpws:getVariableData('queryResponse', 'parameters','/salesforce:queryResponse/salesforce:result/salesforce:records/salesObject:SLA__c') = 'Gold'">
						<assign name="setDiscount">
							<copy>
								<from expression="ceiling(bpws:getVariableData( 'input','payload','/tns:SalesforceFlowRequest/tns:price' ) - bpws:getVariableData( 'input','payload','/tns:SalesforceFlowRequest/tns:price' ) * 0.2)">
								</from>
								<to variable="output" part="payload" query="/tns:SalesforceFlowResponse/tns:price"/>
							</copy>
						</assign>
					</case>
					<case condition="bpws:getVariableData('queryResponse', 'parameters','/salesforce:queryResponse/salesforce:result/salesforce:records/salesObject:SLA__c') = 'Silver'">
						<assign name="setDiscount">
							<copy>
								<from expression="ceiling(bpws:getVariableData( 'input','payload','/tns:SalesforceFlowRequest/tns:price' ) - bpws:getVariableData( 'input','payload','/tns:SalesforceFlowRequest/tns:price' ) * 0.1)">
								</from>
								<to variable="output" part="payload" query="/tns:SalesforceFlowResponse/tns:price"/>
							</copy>
						</assign>
					</case>
					<otherwise>
						<assign name="setDiscount">
							<copy>
								<from variable="input" part="payload" query="/tns:SalesforceFlowRequest/tns:price">
								</from>
								<to variable="output" part="payload" query="/tns:SalesforceFlowResponse/tns:price"/>
							</copy>
						</assign>
					</otherwise>
				</switch>
			</sequence>
		</scope>

		<!-- Asynchronous callback to the requester.
             Note: the callback location and correlation id is transparently handled
             using WS-addressing.
             -->

		<invoke name="callbackClient" partnerLink="client" portType="tns:SalesforceFlowCallback" operation="onResult" inputVariable="output"/>
	</sequence>
</process>
